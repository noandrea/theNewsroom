

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>aeternity.node &mdash; aepp-sdk  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> aepp-sdk
          

          
          </a>

          
            
            
              <div class="version">
                6.2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro/index.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../howto/index.html">“How-to” guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../topics/index.html">Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ref/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/index.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../snippets/index.html">Code Snippets</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">aepp-sdk</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>aeternity.node</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for aeternity.node</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">namedtupled</span>

<span class="kn">from</span> <span class="nn">aeternity.signing</span> <span class="kn">import</span> <span class="n">Account</span>
<span class="kn">from</span> <span class="nn">aeternity.openapi</span> <span class="kn">import</span> <span class="n">OpenAPIClientException</span>
<span class="kn">from</span> <span class="nn">aeternity</span> <span class="kn">import</span> <span class="n">aens</span><span class="p">,</span> <span class="n">openapi</span><span class="p">,</span> <span class="n">transactions</span><span class="p">,</span> <span class="n">contract</span><span class="p">,</span> <span class="n">oracles</span><span class="p">,</span> <span class="n">defaults</span><span class="p">,</span> <span class="n">identifiers</span><span class="p">,</span> <span class="n">exceptions</span><span class="p">,</span> <span class="n">utils</span><span class="p">,</span> <span class="n">hashing</span><span class="p">,</span> <span class="n">compiler</span>
<span class="kn">from</span> <span class="nn">aeternity.exceptions</span> <span class="kn">import</span> <span class="n">TransactionWaitTimeoutExpired</span><span class="p">,</span> <span class="n">TransactionHashMismatch</span>
<span class="kn">from</span> <span class="nn">aeternity</span> <span class="kn">import</span> <span class="n">__node_compatibility__</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="Config"><a class="viewcode-back" href="../../ref/client_and_config.html#aeternity.node.Config">[docs]</a><span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
<div class="viewcode-block" id="Config.__init__"><a class="viewcode-back" href="../../ref/client_and_config.html#aeternity.node.Config.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">external_url</span><span class="o">=</span><span class="s1">&#39;http://localhost:3013&#39;</span><span class="p">,</span>
                 <span class="n">internal_url</span><span class="o">=</span><span class="s1">&#39;http://localhost:3113&#39;</span><span class="p">,</span>
                 <span class="n">websocket_url</span><span class="o">=</span><span class="s1">&#39;http://localhost:3014&#39;</span><span class="p">,</span>
                 <span class="n">force_compatibility</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a configuration object to be used with the NodeClient</span>

<span class="sd">        :param external_url: the node external url</span>
<span class="sd">        :param internal_url: the node internal url</span>
<span class="sd">        :param websocket_url: the node websocket url</span>
<span class="sd">        :param force_compatibility: ignore node version compatibility check (default False)</span>
<span class="sd">        :param `**kwargs`: see below</span>

<span class="sd">        Kwargs:</span>
<span class="sd">            :blocking_mode (bool): whenever to block the execution when broadcasting a transaction until the transaction is mined in the chain, default: False</span>
<span class="sd">            :tx_gas_per_byte (int): the amount of gas per byte used to calculate the transaction fees, [optional, default: defaults.GAS_PER_BYTE]</span>
<span class="sd">            :tx_base_gas (int): the amount of gas per byte used to calculate the transaction fees, [optional, default: defaults.BASE_GAS]</span>
<span class="sd">            :tx_gas_price (int): the gas price used to calculate the transaction fees,</span>
<span class="sd">                it is set by consensus but can be increased by miners [optional, default: defaults.GAS_PRICE]</span>
<span class="sd">            :network_id (str): the id of the network that is the target for the transactions, if not provided it will be automatically selected by the client</span>
<span class="sd">            :contract_gas (int): default gas limit to be used for contract calls, [optional, default: defaults.CONTRACT_GAS]</span>
<span class="sd">            :contract_gas_price (int): default gas price used for contract calls, [optional, default: defaults.CONTRACT_GAS_PRICE]</span>
<span class="sd">            :oracle_ttl_type (int): default oracle ttl type</span>
<span class="sd">            :key_block_interval (int): the key block interval in minutes</span>
<span class="sd">            :key_block_confirmation_num (int): the number of key blocks to consider a transaction confirmed</span>
<span class="sd">            :poll_tx_max_retries (int): max poll retries when checking if a transaction has been included</span>
<span class="sd">            :poll_tx_retries_interval (int): the interval in seconds between retries</span>
<span class="sd">            :poll_block_max_retries (int): TODO</span>
<span class="sd">            :poll_block_retries_interval (int): TODO</span>
<span class="sd">            :debug (bool): enable debug logging for api calls</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># endpoint URLs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_url</span> <span class="o">=</span> <span class="n">external_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_url_internal</span> <span class="o">=</span> <span class="n">internal_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">websocket_url</span> <span class="o">=</span> <span class="n">websocket_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force_compatibility</span> <span class="o">=</span> <span class="n">force_compatibility</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocking_mode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;blocking_mode&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="c1"># defaults # TODO: pass defaults to the tx builder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tx_gas_per_byte</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tx_gas_per_byte&quot;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">GAS_PER_BYTE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tx_base_gas</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tx_base_gas&quot;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">BASE_GAS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tx_gas_price</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tx_gas_price&quot;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">GAS_PRICE</span><span class="p">)</span>
        <span class="c1"># get the version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">network_id</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;network_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># contracts defaults</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contract_gas</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;contract_gas&quot;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">CONTRACT_GAS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contract_gas_price</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;contract_gas_price&quot;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">CONTRACT_GAS_PRICE</span><span class="p">)</span>
        <span class="c1"># oracles default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">oracle_ttl_type</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;oracle_ttl_type&quot;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">ORACLE_TTL_TYPE</span><span class="p">)</span>
        <span class="c1"># chain defaults</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_block_interval</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key_block_interval&quot;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">KEY_BLOCK_INTERVAL</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_block_confirmation_num</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;key_block_confirmation_num&quot;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">KEY_BLOCK_CONFIRMATION_NUM</span><span class="p">)</span>
        <span class="c1"># tuning</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poll_tx_max_retries</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;poll_tx_max_retries&quot;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">POLL_TX_MAX_RETRIES</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poll_tx_retries_interval</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;poll_tx_retries_interval&quot;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">POLL_TX_RETRIES_INTERVAL</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poll_block_max_retries</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;poll_block_max_retries&quot;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">POLL_BLOCK_MAX_RETRIES</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poll_block_retries_interval</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;poll_block_retries_interval&quot;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">POLL_BLOCK_RETRIES_INTERVAL</span><span class="p">)</span>
        <span class="c1"># debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;ws:</span><span class="si">{self.websocket_url}</span><span class="s1"> ext:</span><span class="si">{self.api_url}</span><span class="s1"> int:</span><span class="si">{self.api_url_internal}</span><span class="s1">&#39;</span></div>


<div class="viewcode-block" id="NodeClient"><a class="viewcode-back" href="../../ref/client_and_config.html#aeternity.node.NodeClient">[docs]</a><span class="k">class</span> <span class="nc">NodeClient</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">Config</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a new EpochClient</span>

<span class="sd">        :param config: the configuration to use or empty for default (default None)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="c1"># determine how the transaction are going to be created</span>
        <span class="c1"># if running offline they are forced to be native</span>
        <span class="c1"># shall the client work in blocking mode</span>
        <span class="c1"># instantiate the api client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api</span> <span class="o">=</span> <span class="n">openapi</span><span class="o">.</span><span class="n">OpenAPICli</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">api_url</span><span class="p">,</span>
                                      <span class="n">url_internal</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">api_url_internal</span><span class="p">,</span>
                                      <span class="n">debug</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span>
                                      <span class="n">force_compatibility</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">force_compatibility</span><span class="p">,</span>
                                      <span class="n">compatibility_version_range</span><span class="o">=</span><span class="n">__node_compatibility__</span><span class="p">)</span>
        <span class="c1"># instantiate the transaction builder object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tx_builder</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">TxBuilder</span><span class="p">(</span>
            <span class="n">base_gas</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">tx_base_gas</span><span class="p">,</span>
            <span class="n">gas_per_byte</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">tx_gas_per_byte</span><span class="p">,</span>
            <span class="n">gas_price</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">tx_gas_price</span><span class="p">,</span>
            <span class="n">key_block_interval</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">key_block_interval</span>
        <span class="p">)</span>
        <span class="c1"># network id</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">network_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">network_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span><span class="o">.</span><span class="n">network_id</span>

    <span class="c1"># enable composition</span>
    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>

<div class="viewcode-block" id="NodeClient.compute_absolute_ttl"><a class="viewcode-back" href="../../ref/client_and_config.html#aeternity.node.NodeClient.compute_absolute_ttl">[docs]</a>    <span class="k">def</span> <span class="nf">compute_absolute_ttl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relative_ttl</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the absolute ttl by adding the ttl to the current height of the chain</span>

<span class="sd">        :param relative_ttl: the relative ttl, if 0 will set the ttl to 0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ttl</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">absolute_ttl</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_current_key_block_height</span><span class="p">(),</span>
            <span class="n">estimated_expiration</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">relative_ttl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ttl</span><span class="p">[</span><span class="s2">&quot;absolute_ttl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ttl</span><span class="p">[</span><span class="s2">&quot;height&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">relative_ttl</span>
            <span class="n">ttl</span><span class="p">[</span><span class="s2">&quot;estimated_expiration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">key_block_interval</span> <span class="o">*</span> <span class="n">relative_ttl</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">namedtupled</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">ttl</span><span class="p">,</span> <span class="n">_nt_name</span><span class="o">=</span><span class="s2">&quot;TTL&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="NodeClient.get_next_nonce"><a class="viewcode-back" href="../../ref/client_and_config.html#aeternity.node.NodeClient.get_next_nonce">[docs]</a>    <span class="k">def</span> <span class="nf">get_next_nonce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account_address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the next nonce to be used for a transaction for an account</span>

<span class="sd">        :param node: the node client</span>
<span class="sd">        :return: the next nonce for an account</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">account</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">get_account_by_pubkey</span><span class="p">(</span><span class="n">pubkey</span><span class="o">=</span><span class="n">account_address</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">account</span><span class="o">.</span><span class="n">nonce</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span></div>

    <span class="k">def</span> <span class="nf">_get_nonce_ttl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">relative_ttl</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper method to compute both absolute ttl and  nonce for an account</span>

<span class="sd">        :return: (nonce, ttl)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ttl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_absolute_ttl</span><span class="p">(</span><span class="n">relative_ttl</span><span class="p">)</span><span class="o">.</span><span class="n">absolute_ttl</span> <span class="k">if</span> <span class="n">relative_ttl</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">nonce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_next_nonce</span><span class="p">(</span><span class="n">account_address</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nonce</span><span class="p">,</span> <span class="n">ttl</span>

<div class="viewcode-block" id="NodeClient.get_top_block"><a class="viewcode-back" href="../../ref/client_and_config.html#aeternity.node.NodeClient.get_top_block">[docs]</a>    <span class="k">def</span> <span class="nf">get_top_block</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Override the native method to transform the get top block response object</span>
<span class="sd">        to a Block</span>

<span class="sd">        :return: a block (either key block or micro block)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">get_top_block</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">b</span><span class="o">.</span><span class="n">key_block</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;key_block&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">b</span><span class="o">.</span><span class="n">micro_block</span></div>

<div class="viewcode-block" id="NodeClient.get_block_by_hash"><a class="viewcode-back" href="../../ref/client_and_config.html#aeternity.node.NodeClient.get_block_by_hash">[docs]</a>    <span class="k">def</span> <span class="nf">get_block_by_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve a key block or a micro block header</span>
<span class="sd">        based on the block hash_prefix</span>

<span class="sd">        :param block_hash: either a key block or micro block hash</span>
<span class="sd">        :return: the block matching the hash</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">block</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">hash</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">block</span>
        <span class="k">if</span> <span class="nb">hash</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{identifiers.KEY_BLOCK_HASH}</span><span class="s2">_&quot;</span><span class="p">):</span>
            <span class="c1"># key block</span>
            <span class="n">block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">get_key_block_by_hash</span><span class="p">(</span><span class="nb">hash</span><span class="o">=</span><span class="nb">hash</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hash</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{identifiers.MICRO_BLOCK_HASH}</span><span class="s2">_&quot;</span><span class="p">):</span>
            <span class="c1"># micro block</span>
            <span class="n">block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">get_micro_block_header_by_hash</span><span class="p">(</span><span class="nb">hash</span><span class="o">=</span><span class="nb">hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">block</span></div>

<div class="viewcode-block" id="NodeClient.broadcast_transaction"><a class="viewcode-back" href="../../ref/client_and_config.html#aeternity.node.NodeClient.broadcast_transaction">[docs]</a>    <span class="k">def</span> <span class="nf">broadcast_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx</span><span class="p">:</span> <span class="n">transactions</span><span class="o">.</span><span class="n">TxObject</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Post a transaction to the chain and verify that the hash match the local calculated hash</span>
<span class="sd">        It blocks for a period of time to wait for the transaction to be included if in blocking_mode</span>

<span class="sd">        :param tx: the transaction to broadcast</span>
<span class="sd">        :return: the transaction hash of the transaction</span>

<span class="sd">        :raises TransactionHashMismatch: if the transaction hash returned by the node is different from the one calculated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reply</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_transaction</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;tx&quot;</span><span class="p">:</span> <span class="n">tx</span><span class="o">.</span><span class="n">tx</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">reply</span><span class="o">.</span><span class="n">tx_hash</span> <span class="o">!=</span> <span class="n">tx</span><span class="o">.</span><span class="n">hash</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TransactionHashMismatch</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transaction hash doesn&#39;t match, expected </span><span class="si">{tx.hash}</span><span class="s2"> got </span><span class="si">{reply.tx_hash}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">blocking_mode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_transaction</span><span class="p">(</span><span class="n">reply</span><span class="o">.</span><span class="n">tx_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">reply</span><span class="o">.</span><span class="n">tx_hash</span></div>

<div class="viewcode-block" id="NodeClient.sign_transaction"><a class="viewcode-back" href="../../ref/client_and_config.html#aeternity.node.NodeClient.sign_transaction">[docs]</a>    <span class="k">def</span> <span class="nf">sign_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">:</span> <span class="n">Account</span><span class="p">,</span> <span class="n">tx</span><span class="p">:</span> <span class="n">transactions</span><span class="o">.</span><span class="n">TxObject</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">transactions</span><span class="o">.</span><span class="n">TxObject</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The function sign a transaction to be broadcast to the chain.</span>
<span class="sd">        It automatically detect if the account is Basic or GA and return</span>
<span class="sd">        the correct transaction to be broadcast.</span>

<span class="sd">        :param account: the account signing the transaction</span>
<span class="sd">        :param tx: the transaction to be signed</span>
<span class="sd">        :param metadata: additional metadata to maintain in the TxObject</span>
<span class="sd">        :param `**kwargs`:  for GA accounts, see below</span>

<span class="sd">        Kwargs:</span>
<span class="sd">            :auth_data (str): the encoded calldata for the GA auth function</span>
<span class="sd">            :gas (int): the gas limit for the GA auth function [optional]</span>
<span class="sd">            :gas_price (int): the gas price for the GA auth function [optional]</span>
<span class="sd">            :fee (int): the fee for the GA transaction [optional, automatically calculated]</span>
<span class="sd">            :abi_version (int): the abi_version to select FATE or AEVM [optional, default 3/FATE]</span>
<span class="sd">            :ttl (str): the transaction ttl expressed in relative number of blocks [optional, default 0/max_ttl]:</span>

<span class="sd">        :return: a TxObject of the signed transaction or metat transaction for GA</span>
<span class="sd">        :raises TypeError: if the auth_data is missing and the account is GA</span>
<span class="sd">        :raises TypeError: if the gas for auth_func is gt defaults.GA_MAX_AUTH_FUN_GAS</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># first retrieve the account from the node</span>
        <span class="c1"># so we can check if it is generalized or not</span>
        <span class="n">on_chain_account</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_account</span><span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">get_address</span><span class="p">())</span>

        <span class="c1"># if the account is not generalized sign and return the transaction</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">on_chain_account</span><span class="o">.</span><span class="n">is_generalized</span><span class="p">():</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">transactions</span><span class="o">.</span><span class="n">TxSigner</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">network_id</span><span class="p">)</span>
            <span class="n">signature</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tx_builder</span><span class="o">.</span><span class="n">tx_signed</span><span class="p">([</span><span class="n">signature</span><span class="p">],</span> <span class="n">tx</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>

        <span class="c1"># if the account is generalized then prepare the ga_meta_tx</span>
        <span class="c1"># 1. wrap the tx into a signed tx (without signatures)</span>
        <span class="n">sg_tx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tx_builder</span><span class="o">.</span><span class="n">tx_signed</span><span class="p">([],</span> <span class="n">tx</span><span class="p">)</span>
        <span class="c1"># 2. wrap the tx into a ga_meta_tx</span>
        <span class="c1"># get the absolute ttl</span>
        <span class="n">ttl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_absolute_ttl</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ttl&quot;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">TX_TTL</span><span class="p">))</span><span class="o">.</span><span class="n">absolute_ttl</span>
        <span class="c1"># get abi version</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">abi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vm_abi_versions</span><span class="p">()</span>
        <span class="c1"># check that the parameter auth_data is provided</span>
        <span class="n">auth_data</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;auth_data&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">auth_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;the auth_data parameter is required for ga accounts&quot;</span><span class="p">)</span>
        <span class="c1"># verify the gas amount TODO: add a tx verification</span>
        <span class="n">gas</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gas&quot;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">GA_MAX_AUTH_FUN_GAS</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gas</span> <span class="o">&gt;</span> <span class="n">defaults</span><span class="o">.</span><span class="n">GA_MAX_AUTH_FUN_GAS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;the maximum gas value for ga auth_fun is </span><span class="si">{defaults.GA_MAX_AUTH_FUN_GAS}</span><span class="s2">, got </span><span class="si">{gas}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># build the</span>
        <span class="n">ga_sg_tx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tx_builder</span><span class="o">.</span><span class="n">tx_ga_meta</span><span class="p">(</span>
            <span class="n">account</span><span class="o">.</span><span class="n">get_address</span><span class="p">(),</span>
            <span class="n">auth_data</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;abi_version&quot;</span><span class="p">,</span> <span class="n">abi</span><span class="p">),</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fee&quot;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">FEE</span><span class="p">),</span>
            <span class="n">gas</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gas_price&quot;</span><span class="p">,</span> <span class="n">defaults</span><span class="o">.</span><span class="n">CONTRACT_GAS_PRICE</span><span class="p">),</span>
            <span class="n">ttl</span><span class="p">,</span>
            <span class="n">sg_tx</span>
        <span class="p">)</span>
        <span class="c1"># 3. wrap the the ga into a signed transaction</span>
        <span class="n">sg_ga_sg_tx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tx_builder</span><span class="o">.</span><span class="n">tx_signed</span><span class="p">([],</span> <span class="n">ga_sg_tx</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sg_ga_sg_tx</span></div>

<div class="viewcode-block" id="NodeClient.get_account"><a class="viewcode-back" href="../../ref/client_and_config.html#aeternity.node.NodeClient.get_account">[docs]</a>    <span class="k">def</span> <span class="nf">get_account</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Account</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve an account by it&#39;s public key</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_valid_hash</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">identifiers</span><span class="o">.</span><span class="n">ACCOUNT_ID</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input </span><span class="si">{address}</span><span class="s2"> is not a valid aeternity address&quot;</span><span class="p">)</span>
        <span class="n">remote_account</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_account_by_pubkey</span><span class="p">(</span><span class="n">pubkey</span><span class="o">=</span><span class="n">address</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Account</span><span class="o">.</span><span class="n">from_node_api</span><span class="p">(</span><span class="n">remote_account</span><span class="p">)</span></div>

<div class="viewcode-block" id="NodeClient.get_balance"><a class="viewcode-back" href="../../ref/client_and_config.html#aeternity.node.NodeClient.get_balance">[docs]</a>    <span class="k">def</span> <span class="nf">get_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the balance of an account, return 0 if the account has not balance</span>

<span class="sd">        :param account: either an account address or a signing.Account object</span>
<span class="sd">        :return: the account balance or 0 if the account is not known to the network</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">address</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">get_address</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">Account</span><span class="p">)</span> <span class="k">else</span> <span class="n">account</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_account</span><span class="p">(</span><span class="n">address</span><span class="p">)</span><span class="o">.</span><span class="n">balance</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span></div>

    <span class="k">def</span> <span class="nf">get_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction_hash</span><span class="p">):</span>  <span class="c1"># TODO: continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_valid_hash</span><span class="p">(</span><span class="n">transaction_hash</span><span class="p">,</span> <span class="n">identifiers</span><span class="o">.</span><span class="n">TRANSACTION_HASH</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input </span><span class="si">{transaction_hash}</span><span class="s2"> is not a valid aeternity address&quot;</span><span class="p">)</span>
        <span class="n">tx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transaction_by_hash</span><span class="p">(</span><span class="nb">hash</span><span class="o">=</span><span class="n">transaction_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tx_builder</span><span class="o">.</span><span class="n">parse_node_reply</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>

<div class="viewcode-block" id="NodeClient.spend"><a class="viewcode-back" href="../../ref/client_and_config.html#aeternity.node.NodeClient.spend">[docs]</a>    <span class="k">def</span> <span class="nf">spend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">:</span> <span class="n">Account</span><span class="p">,</span>
              <span class="n">recipient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
              <span class="n">amount</span><span class="p">,</span>
              <span class="n">payload</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
              <span class="n">fee</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">FEE</span><span class="p">,</span>
              <span class="n">tx_ttl</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">TX_TTL</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">transactions</span><span class="o">.</span><span class="n">TxObject</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create and execute a spend transaction,</span>
<span class="sd">        automatically retrieve the nonce for the siging account</span>
<span class="sd">        and calculate the absolut ttl.</span>

<span class="sd">        :param account: the account signing the spend transaction (sender)</span>
<span class="sd">        :param recipient_id: the recipient address or name_id</span>
<span class="sd">        :param amount: the amount to spend</span>
<span class="sd">        :param payload: the payload for the transaction</span>
<span class="sd">        :param fee: the fee for the transaction (automatically calculated if not provided)</span>
<span class="sd">        :param tx_ttl: the transaction ttl expressed in relative number of blocks</span>

<span class="sd">        :return: the TxObject of the transaction</span>

<span class="sd">        :raises TypeError:  if the recipient_id is not a valid name_id or address</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_valid_aens_name</span><span class="p">(</span><span class="n">recipient_id</span><span class="p">):</span>
            <span class="n">recipient_id</span> <span class="o">=</span> <span class="n">hashing</span><span class="o">.</span><span class="n">name_id</span><span class="p">(</span><span class="n">recipient_id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_valid_hash</span><span class="p">(</span><span class="n">recipient_id</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;ak&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid recipient_id. Please provide a valid AENS name or account pub_key.&quot;</span><span class="p">)</span>
        <span class="c1"># parse amount and fee</span>
        <span class="n">amount</span><span class="p">,</span> <span class="n">fee</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">_amounts_to_aettos</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">fee</span><span class="p">)</span>
        <span class="c1"># retrieve the nonce</span>
        <span class="n">account</span><span class="o">.</span><span class="n">nonce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_next_nonce</span><span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">get_address</span><span class="p">())</span> <span class="k">if</span> <span class="n">account</span><span class="o">.</span><span class="n">nonce</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">account</span><span class="o">.</span><span class="n">nonce</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c1"># retrieve ttl</span>
        <span class="n">tx_ttl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_absolute_ttl</span><span class="p">(</span><span class="n">tx_ttl</span><span class="p">)</span>
        <span class="c1"># build the transaction</span>
        <span class="n">tx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tx_builder</span><span class="o">.</span><span class="n">tx_spend</span><span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">get_address</span><span class="p">(),</span> <span class="n">recipient_id</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">fee</span><span class="p">,</span> <span class="n">tx_ttl</span><span class="o">.</span><span class="n">absolute_ttl</span><span class="p">,</span> <span class="n">account</span><span class="o">.</span><span class="n">nonce</span><span class="p">)</span>
        <span class="c1"># get the signature</span>
        <span class="n">tx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">tx</span><span class="p">)</span>
        <span class="c1"># post the signed transaction transaction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">broadcast_transaction</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tx</span></div>

<div class="viewcode-block" id="NodeClient.wait_for_transaction"><a class="viewcode-back" href="../../ref/client_and_config.html#aeternity.node.NodeClient.wait_for_transaction">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx_hash</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">polling_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait for a transaction to be mined for an account</span>
<span class="sd">        The method will wait for a specific transaction to be included in the chain,</span>
<span class="sd">        it will return False if one of the following conditions are met:</span>
<span class="sd">        - the chain reply with a 404 not found (the transaction was expunged)</span>
<span class="sd">        - the account nonce is &gt;= of the transaction nonce (transaction is in an illegal state)</span>
<span class="sd">        - the ttl of the transaction or the one passed as parameter has been reached</span>

<span class="sd">        :param tx_hash: the hash of the transaction to wait for</span>
<span class="sd">        :param max_retries: the maximum number of retries to test for transaction</span>
<span class="sd">        :param polling_interval: the interval between transaction polls</span>
<span class="sd">        :return: the block height of the transaction if it has been found</span>

<span class="sd">        :raises TransactionWaitTimeoutExpired: if the transaction hasn&#39;t been found</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">retries</span> <span class="o">=</span> <span class="n">max_retries</span> <span class="k">if</span> <span class="n">max_retries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">poll_tx_max_retries</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="n">polling_interval</span> <span class="k">if</span> <span class="n">polling_interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">poll_tx_retries_interval</span>
        <span class="k">if</span> <span class="n">retries</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Retries must be greater than 0&quot;</span><span class="p">)</span>

        <span class="c1"># start polling</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">total_sleep</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># tx_height = -1</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># query the transaction</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_transaction_by_hash</span><span class="p">(</span><span class="nb">hash</span><span class="o">=</span><span class="n">tx_hash</span><span class="p">)</span>
                <span class="c1"># get the account nonce</span>
            <span class="k">except</span> <span class="n">OpenAPIClientException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># it may fail because it is not found that means that</span>
                <span class="c1"># or it was invalid or the ttl has expired</span>
                <span class="n">reason</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">reason</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;Timeout expired&quot;</span>
                <span class="k">raise</span> <span class="n">TransactionWaitTimeoutExpired</span><span class="p">(</span><span class="n">tx_hash</span><span class="o">=</span><span class="n">tx_hash</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="n">reason</span><span class="p">)</span>
            <span class="c1"># if the tx.block_height &gt;= min_block_height we are ok</span>
            <span class="k">if</span> <span class="n">tx</span><span class="o">.</span><span class="n">block_height</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">tx_height</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="n">block_height</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">retries</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TransactionWaitTimeoutExpired</span><span class="p">(</span><span class="n">tx_hash</span><span class="o">=</span><span class="n">tx_hash</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;The transaction was not included in </span><span class="si">{total_sleep}</span><span class="s2"> seconds, wait aborted&quot;</span><span class="p">)</span>
            <span class="c1"># calculate sleep time</span>
            <span class="n">sleep_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">interval</span> <span class="o">**</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
            <span class="n">total_sleep</span> <span class="o">+=</span> <span class="n">sleep_time</span>
            <span class="c1"># increment n</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">tx_height</span></div>

<div class="viewcode-block" id="NodeClient.wait_for_confirmation"><a class="viewcode-back" href="../../ref/client_and_config.html#aeternity.node.NodeClient.wait_for_confirmation">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_confirmation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx_hash</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">polling_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait for a transaction to be confirmed by at least &quot;key_block_confirmation_num&quot; blocks (default 3)</span>
<span class="sd">        The amount of blocks can be configured in the Config object using key_block_confirmation_num parameter</span>

<span class="sd">        :param tx_hash: the hash of the transaction to wait for</span>
<span class="sd">        :param max_retries: the maximum number of retries to test for transaction</span>
<span class="sd">        :param polling_interval: the interval between transaction polls</span>
<span class="sd">        :return: the block height of the transaction if it has been found</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># first wait for the transaction to be found</span>
        <span class="n">tx_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_transaction</span><span class="p">(</span><span class="n">tx_hash</span><span class="p">)</span>
        <span class="c1"># now calculate the min block height</span>
        <span class="n">min_block_height</span> <span class="o">=</span> <span class="n">tx_height</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">key_block_confirmation_num</span>
        <span class="c1"># get teh</span>
        <span class="n">retries</span> <span class="o">=</span> <span class="n">max_retries</span> <span class="k">if</span> <span class="n">max_retries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">poll_block_max_retries</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="n">polling_interval</span> <span class="k">if</span> <span class="n">polling_interval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">poll_block_retries_interval</span>
        <span class="k">if</span> <span class="n">retries</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">interval</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;max_retries and polling_interval must be greater than 0&quot;</span><span class="p">)</span>
        <span class="c1"># start polling</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">total_sleep</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">current_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_key_block_height</span><span class="p">()</span>
            <span class="c1"># if the tx.block_height &gt;= min_block_height we are ok</span>
            <span class="k">if</span> <span class="n">current_height</span> <span class="o">&gt;=</span> <span class="n">min_block_height</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="n">retries</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TransactionWaitTimeoutExpired</span><span class="p">(</span><span class="n">tx_hash</span><span class="o">=</span><span class="n">tx_hash</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;The transaction was not included in </span><span class="si">{total_sleep}</span><span class="s2"> seconds, wait aborted&quot;</span><span class="p">)</span>
            <span class="c1"># calculate sleep time</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
            <span class="n">total_sleep</span> <span class="o">+=</span> <span class="n">interval</span>
            <span class="c1"># increment n</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">tx_height</span></div>

<div class="viewcode-block" id="NodeClient.transfer_funds"><a class="viewcode-back" href="../../ref/client_and_config.html#aeternity.node.NodeClient.transfer_funds">[docs]</a>    <span class="k">def</span> <span class="nf">transfer_funds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">:</span> <span class="n">Account</span><span class="p">,</span>
                       <span class="n">recipient_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">percentage</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                       <span class="n">payload</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                       <span class="n">tx_ttl</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">TX_TTL</span><span class="p">,</span>
                       <span class="n">fee</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">FEE</span><span class="p">,</span>
                       <span class="n">include_fee</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create and execute a spend transaction</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_valid_aens_name</span><span class="p">(</span><span class="n">recipient_id</span><span class="p">):</span>
            <span class="n">recipient_id</span> <span class="o">=</span> <span class="n">hashing</span><span class="o">.</span><span class="n">name_id</span><span class="p">(</span><span class="n">recipient_id</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_valid_hash</span><span class="p">(</span><span class="n">recipient_id</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;ak&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Invalid recipient_id. Please provide a valid AENS name or account pub_key.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">percentage</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">percentage</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Percentage should be a number between 0 and 1, got </span><span class="si">{percentage}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># parse amounts</span>
        <span class="n">fee</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">amount_to_aettos</span><span class="p">(</span><span class="n">fee</span><span class="p">)</span>
        <span class="c1"># retrieve the balance</span>
        <span class="n">account_on_chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_account_by_pubkey</span><span class="p">(</span><span class="n">pubkey</span><span class="o">=</span><span class="n">account</span><span class="o">.</span><span class="n">get_address</span><span class="p">())</span>
        <span class="n">request_transfer_amount</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">account_on_chain</span><span class="o">.</span><span class="n">balance</span> <span class="o">*</span> <span class="n">percentage</span><span class="p">)</span>
        <span class="c1"># retrieve the nonce</span>
        <span class="n">account</span><span class="o">.</span><span class="n">nonce</span> <span class="o">=</span> <span class="n">account_on_chain</span><span class="o">.</span><span class="n">nonce</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c1"># retrieve ttl</span>
        <span class="n">tx_ttl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_absolute_ttl</span><span class="p">(</span><span class="n">tx_ttl</span><span class="p">)</span>
        <span class="c1"># build the transaction</span>
        <span class="n">tx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tx_builder</span><span class="o">.</span><span class="n">tx_spend</span><span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">get_address</span><span class="p">(),</span> <span class="n">recipient_id</span><span class="p">,</span> <span class="n">request_transfer_amount</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">fee</span><span class="p">,</span> <span class="n">tx_ttl</span><span class="o">.</span><span class="n">absolute_ttl</span><span class="p">,</span> <span class="n">account</span><span class="o">.</span><span class="n">nonce</span><span class="p">)</span>
        <span class="c1"># if the request_transfer_amount should include the fee keep calculating the fee</span>
        <span class="k">if</span> <span class="n">include_fee</span><span class="p">:</span>
            <span class="n">amount</span> <span class="o">=</span> <span class="n">request_transfer_amount</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">amount</span> <span class="o">+</span> <span class="n">tx</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fee</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">request_transfer_amount</span><span class="p">:</span>
                <span class="n">amount</span> <span class="o">=</span> <span class="n">request_transfer_amount</span> <span class="o">-</span> <span class="n">tx</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">fee</span>
                <span class="n">tx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tx_builder</span><span class="o">.</span><span class="n">tx_spend</span><span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">get_address</span><span class="p">(),</span> <span class="n">recipient_id</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">fee</span><span class="p">,</span> <span class="n">tx_ttl</span><span class="o">.</span><span class="n">absolute_ttl</span><span class="p">,</span> <span class="n">account</span><span class="o">.</span><span class="n">nonce</span><span class="p">)</span>
        <span class="c1"># execute the transaction</span>
        <span class="n">tx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">tx</span><span class="p">)</span>
        <span class="c1"># post the transaction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">broadcast_transaction</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tx</span></div>

<div class="viewcode-block" id="NodeClient.get_consensus_protocol_version"><a class="viewcode-back" href="../../ref/client_and_config.html#aeternity.node.NodeClient.get_consensus_protocol_version">[docs]</a>    <span class="k">def</span> <span class="nf">get_consensus_protocol_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the consensus protocol version number</span>
<span class="sd">        :param height: the height to get the protocol version for, if None the current height will be used</span>
<span class="sd">        :return: the version</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">height</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_key_block_height</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">height</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;height must be a number &gt;= 0&quot;</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
        <span class="n">effective_at_height</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">version</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">status</span><span class="o">.</span><span class="n">protocols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">height</span> <span class="o">&gt;=</span> <span class="n">p</span><span class="o">.</span><span class="n">effective_at_height</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">effective_at_height</span> <span class="o">&gt;</span> <span class="n">effective_at_height</span><span class="p">:</span>
                <span class="n">version</span><span class="p">,</span> <span class="n">effective_at_height</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">effective_at_height</span>
        <span class="k">return</span> <span class="n">version</span></div>

<div class="viewcode-block" id="NodeClient.verify"><a class="viewcode-back" href="../../ref/client_and_config.html#aeternity.node.NodeClient.verify">[docs]</a>    <span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoded_tx</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">transactions</span><span class="o">.</span><span class="n">TxObject</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unpack and verify an encoded transaction</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">decoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tx_builder</span><span class="o">.</span><span class="n">parse_tx_string</span><span class="p">(</span><span class="n">encoded_tx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">decoded</span></div>

<div class="viewcode-block" id="NodeClient.get_vm_abi_versions"><a class="viewcode-back" href="../../ref/client_and_config.html#aeternity.node.NodeClient.get_vm_abi_versions">[docs]</a>    <span class="k">def</span> <span class="nf">get_vm_abi_versions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the version of the node and retrieve the correct values for abi and vm version</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">protocol_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_consensus_protocol_version</span><span class="p">()</span>
        <span class="n">protocol_abi_vm</span> <span class="o">=</span> <span class="n">identifiers</span><span class="o">.</span><span class="n">PROTOCOL_ABI_VM</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">protocol_version</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">protocol_abi_vm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">UnsupportedNodeVersion</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Version </span><span class="si">{self.api_version}</span><span class="s2"> is not supported&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">protocol_abi_vm</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vm&quot;</span><span class="p">),</span> <span class="n">protocol_abi_vm</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;abi&quot;</span><span class="p">))</span></div>

<div class="viewcode-block" id="NodeClient.account_basic_to_ga"><a class="viewcode-back" href="../../ref/client_and_config.html#aeternity.node.NodeClient.account_basic_to_ga">[docs]</a>    <span class="k">def</span> <span class="nf">account_basic_to_ga</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">account</span><span class="p">:</span> <span class="n">Account</span><span class="p">,</span> <span class="n">ga_contract</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">calldata</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                            <span class="n">auth_fun</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">GA_AUTH_FUNCTION</span><span class="p">,</span>
                            <span class="n">fee</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">FEE</span><span class="p">,</span>
                            <span class="n">tx_ttl</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">TX_TTL</span><span class="p">,</span>
                            <span class="n">gas</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">CONTRACT_GAS</span><span class="p">,</span>
                            <span class="n">gas_price</span><span class="o">=</span><span class="n">defaults</span><span class="o">.</span><span class="n">CONTRACT_GAS_PRICE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">transactions</span><span class="o">.</span><span class="n">TxObject</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform a Basic to a GA (Generalized Account)</span>

<span class="sd">        :param account: the account to transform</span>
<span class="sd">        :param ga_contract: the compiled contract associated to the GA</span>
<span class="sd">        :param calldata: the calldata for the authentication function</span>
<span class="sd">        :param auth_fun: the name of the contract function to use for authorization (default: authorize)</span>
<span class="sd">        :param gas: the gas limit for the authorization function execution</span>
<span class="sd">        :param gas_price: the gas price for the contract execution</span>
<span class="sd">        :param fee: TODO</span>
<span class="sd">        :param ttl: TODO</span>

<span class="sd">        :return: the TxObject of the transaction</span>

<span class="sd">        :raises TypeError: if the auth_fun is missing</span>
<span class="sd">        :raises TypeError: if the auth_fun is no found in the contract</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check the auth_fun name</span>
        <span class="k">if</span> <span class="n">auth_fun</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">auth_fun</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The parameter auth_fun is required&quot;</span><span class="p">)</span>
        <span class="c1"># parse amounts</span>
        <span class="n">fee</span><span class="p">,</span> <span class="n">gas_price</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">_amounts_to_aettos</span><span class="p">(</span><span class="n">fee</span><span class="p">,</span> <span class="n">gas_price</span><span class="p">)</span>
        <span class="c1"># decode the contract and search for the authorization function</span>
        <span class="n">auth_fun_hash</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">contract_data</span> <span class="o">=</span> <span class="n">compiler</span><span class="o">.</span><span class="n">CompilerClient</span><span class="o">.</span><span class="n">decode_bytecode</span><span class="p">(</span><span class="n">ga_contract</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">contract_data</span><span class="o">.</span><span class="n">type_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># TODO: we assume is a FATE env, but is a bit weak</span>
            <span class="n">auth_fun_hash</span> <span class="o">=</span> <span class="n">hashing</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">auth_fun</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="n">contract_data</span><span class="o">.</span><span class="n">type_info</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ti</span><span class="o">.</span><span class="n">fun_name</span> <span class="o">==</span> <span class="n">auth_fun</span><span class="p">:</span>
                <span class="n">auth_fun_hash</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">fun_hash</span>
        <span class="c1"># if the function is not found then raise an error</span>
        <span class="k">if</span> <span class="n">auth_fun_hash</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Authorization function not found: &#39;</span><span class="si">{auth_fun}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="c1"># get the nonce</span>
        <span class="n">nonce</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_next_nonce</span><span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">get_address</span><span class="p">())</span>
        <span class="c1"># compute the ttl</span>
        <span class="n">ttl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_absolute_ttl</span><span class="p">(</span><span class="n">tx_ttl</span><span class="p">)</span><span class="o">.</span><span class="n">absolute_ttl</span>
        <span class="c1"># get abi and vm version</span>
        <span class="n">vm_version</span><span class="p">,</span> <span class="n">abi_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vm_abi_versions</span><span class="p">()</span>
        <span class="c1"># build the transaction</span>
        <span class="n">tx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tx_builder</span><span class="o">.</span><span class="n">tx_ga_attach</span><span class="p">(</span>
            <span class="n">account</span><span class="o">.</span><span class="n">get_address</span><span class="p">(),</span>
            <span class="n">nonce</span><span class="p">,</span>
            <span class="n">ga_contract</span><span class="p">,</span>
            <span class="n">auth_fun_hash</span><span class="p">,</span>
            <span class="n">vm_version</span><span class="p">,</span>
            <span class="n">abi_version</span><span class="p">,</span>
            <span class="n">fee</span><span class="p">,</span>
            <span class="n">ttl</span><span class="p">,</span>
            <span class="n">gas</span><span class="p">,</span>
            <span class="n">gas_price</span><span class="p">,</span>
            <span class="n">calldata</span>
        <span class="p">)</span>
        <span class="c1"># sign the transaction</span>
        <span class="n">tx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">tx</span><span class="p">)</span>
        <span class="c1"># broadcast the transaction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">broadcast_transaction</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tx</span></div>

    <span class="c1"># support naming</span>
    <span class="k">def</span> <span class="nf">AEName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">aens</span><span class="o">.</span><span class="n">AEName</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="c1"># support oracles</span>
    <span class="k">def</span> <span class="nf">Oracle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">oracles</span><span class="o">.</span><span class="n">Oracle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">OracleQuery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oracle_id</span><span class="p">,</span> <span class="n">query_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">oracles</span><span class="o">.</span><span class="n">OracleQuery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oracle_id</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">query_id</span><span class="p">)</span>

    <span class="c1"># support contract</span>
    <span class="k">def</span> <span class="nf">Contract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">contract</span><span class="o">.</span><span class="n">Contract</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Andrea Giacobino, Shubhendu Shekhar

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>